{% extends "base.html" %}
{% block title %}Editor IG ‚Äî {{ brand_display }}{% endblock %}
{% block body %}
<div class="portal theme-{{ brand }}">
  <header class="portal-header">
    <div class="container">
      <div class="header-row">
        <div class="header-left">
          <a href="/ui/{{ brand }}/news/{{ news.id }}" class="breadcrumb">‚Üê Volver a noticia</a>
          <h1>{{ brand_display }} ‚Äî Editor IG</h1>
        </div>
        <div class="header-right">
          <div class="brand-switch">
            <select onchange="location.href='/ui/'+this.value+'/draft/{{ draft.id }}'">
              {% for key, config in brands.items() %}
              <option value="{{ key }}" {% if key == brand %}selected{% endif %}>{{ config.display }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main class="portal-main draft-editor">
    <div class="container">
      <div id="toast" class="toast hidden"></div>

      <div class="editor-shell">
        <section class="editor-pane card">
          <div class="card-inner">
            <div class="field">
              <label>Hook</label>
              <textarea id="hook" rows="2">{{ draft.hook or '' }}</textarea>
            </div>

            <div class="field" id="carouselField" data-slide-count="{{ (draft.carousel_slides|length) if draft.carousel_slides else 3 }}">
              <h4 class="section-title">Carrusel</h4>
              <div class="slide-tabs" id="slideTabs">
                {% for i in range((draft.carousel_slides|length) if draft.carousel_slides else 3) %}
                <button type="button" class="slide-tab {% if i == 0 %}active{% endif %}" data-idx="{{ i }}">{{ i + 1 }}</button>
                {% endfor %}
              </div>
              {% for i in range((draft.carousel_slides|length) if draft.carousel_slides else 3) %}
              <div class="slide-editor {% if i == 0 %}active{% endif %}" data-idx="{{ i }}">
                {% set slide = (draft.carousel_slides or [])[i] if draft.carousel_slides and (draft.carousel_slides|length) > i else {} %}
                <div class="inline-row">
                  <label>T√≠tulo <span class="counter" id="titleCount{{ i }}">0</span></label>
                </div>
                <input type="text" class="slide-title" data-i="{{ i }}" placeholder="T√≠tulo" value="{{ slide.get('title', '') }}">
                <div class="inline-row">
                  <label>Body <span class="counter" id="bodyCount{{ i }}">0/110</span></label>
                </div>
                <textarea class="slide-body" data-i="{{ i }}" placeholder="Body (recomendado ‚â§110 chars para IG)" rows="4">{{ slide.get('body', '') }}</textarea>
              </div>
              {% endfor %}
            </div>

            <div class="field">
              <label>Caption <span class="counter" id="captionCount">0/900</span></label>
              <textarea id="caption" rows="5">{{ draft.caption or '' }}</textarea>
            </div>

            <div class="field">
              <label>Hashtags</label>
              <div class="chips" id="hashtagChips"></div>
              <div class="inline-row" style="margin-top:8px">
                <input type="text" id="hashtagInput" placeholder="A√±adir #tag" onkeydown="if(event.key==='Enter'){addHashtag();event.preventDefault()}">
                <button type="button" class="btn btn-ghost" onclick="addHashtag()">+ A√±adir</button>
              </div>
            </div>

            <div class="field">
              <label>CTA</label>
              <input type="text" id="cta" value="{{ draft.cta or '' }}">
            </div>
            <div class="field">
              <label>Source line</label>
              <input type="text" id="source_line" value="{{ draft.source_line or '' }}">
            </div>
            <div class="field">
              <label>Disclaimer</label>
              <textarea id="disclaimer" rows="2">{{ draft.disclaimer or '' }}</textarea>
            </div>

            <div class="editor-actions">
              <div class="bar">
                <div class="left">
                  <div class="copy-dropdown">
                    <button type="button" class="btn" onclick="toggleCopyMenu()" title="Copiar partes del contenido al portapapeles">Copiar ‚ñæ</button>
                    <div class="copy-menu hidden" id="copyMenu">
                      <button type="button" onclick="copyCaption();closeCopyMenu()" title="Pie de foto completo">Pie de foto</button>
                      <button type="button" onclick="copyCurrentSlide();closeCopyMenu()" title="T√≠tulo y body del slide visible">Slide visible</button>
                      <button type="button" onclick="copyCarousel();closeCopyMenu()" title="Todos los slides del carrusel">Carrusel</button>
                      <button type="button" onclick="copyAll();closeCopyMenu()" title="Pie de foto, carrusel, hashtags y fuente">Todo</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <aside class="preview-pane">
          <div class="phone card">
            <div class="phone-inner">
              <div class="ig-topbar">
                <div class="ig-user">
                  <div class="ig-avatar"></div>
                  <div>
                    <div class="ig-handle" id="previewBrand">{{ brand_display }}</div>
                    <div class="ig-sub">Estudio de noticias</div>
                  </div>
                </div>
                <div class="ig-menu">‚ãØ</div>
              </div>
              <div class="ig-media">
                <div class="slide-text">
                  <div class="slide-title" id="previewTitle"></div>
                  <div class="slide-body" id="previewBody"></div>
                </div>
              </div>
              <div class="ig-dots" id="igDots"></div>
              <div class="ig-actions">
                <div class="left"><span>‚ô•</span> <span>üí¨</span> <span>‚Üó</span></div>
              </div>
              <div class="ig-caption">
                <div class="text" id="previewCaption"></div>
                <div class="more" id="previewMore">m√°s‚Ä¶</div>
                <div class="hashtags" id="previewHashtags"></div>
              </div>
            </div>
          </div>
        </aside>
      </div>
    </div>
  </main>
</div>

<script>
const draftId = "{{ draft.id }}";
const brand = "{{ brand }}";
const brandDisplay = "{{ brand_display }}";
let activeSlideIdx = 0;
let hashtags = {{ (draft.hashtags or [])|tojson }};

function getSlides() {
  const slides = [];
  const count = parseInt(document.getElementById('carouselField')?.dataset?.slideCount || '3', 10);
  for (let i = 0; i < count; i++) {
    const titleEl = document.querySelector(`input.slide-title[data-i="${i}"]`);
    const bodyEl = document.querySelector(`textarea.slide-body[data-i="${i}"]`);
    slides.push({ title: titleEl ? titleEl.value : '', body: bodyEl ? bodyEl.value : '' });
  }
  return slides;
}

function setActiveSlide(idx) {
  activeSlideIdx = idx;
  document.querySelectorAll('.slide-tab').forEach((b, i) => b.classList.toggle('active', i === idx));
  document.querySelectorAll('.slide-editor').forEach((d, i) => d.classList.toggle('active', i === idx));
  updatePreview();
}

document.getElementById('slideTabs').addEventListener('click', e => {
  const btn = e.target.closest('.slide-tab');
  if (btn) setActiveSlide(parseInt(btn.dataset.idx));
});

function renderHashtags() {
  const cont = document.getElementById('hashtagChips');
  cont.innerHTML = hashtags.map((h, i) =>
    `<span class="chip">${h.startsWith('#') ? h : '#'+h} <button type="button" onclick="removeHashtag(${i})">√ó</button></span>`
  ).join('');
  document.getElementById('previewHashtags').innerHTML = hashtags.map(h =>
    `<span>${h.startsWith('#') ? h : '#'+h}</span>`
  ).join(' ');
}

function addHashtag() {
  const inp = document.getElementById('hashtagInput');
  let v = inp.value.trim();
  if (!v) return;
  if (!v.startsWith('#')) v = '#' + v;
  if (!hashtags.includes(v)) hashtags.push(v);
  inp.value = '';
  renderHashtags();
}

function removeHashtag(i) { hashtags.splice(i, 1); renderHashtags(); }

function getPayload() {
  return {
    hook: document.getElementById('hook').value,
    carousel_slides: getSlides(),
    caption: document.getElementById('caption').value,
    hashtags: hashtags.length ? hashtags : null,
    cta: document.getElementById('cta').value || null,
    source_line: document.getElementById('source_line').value,
    disclaimer: document.getElementById('disclaimer').value || null,
  };
}

function showToast(msg, type) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast ' + (type || '');
  t.classList.remove('hidden');
  setTimeout(() => t.classList.add('hidden'), 4000);
}

function updatePreview() {
  const slides = getSlides();
  const s = slides[activeSlideIdx] || { title: '', body: '' };
  document.getElementById('previewTitle').textContent = s.title || (activeSlideIdx === 0 ? 'T√≠tulo' : '');
  document.getElementById('previewBody').textContent = (s.body || '') || 'Body del slide';

  const slideCount = getSlides().length;
  document.getElementById('igDots').innerHTML = Array.from({length: slideCount}, (_, i) => i).map(i =>
    `<span class="dot ${i === activeSlideIdx ? 'active' : ''}" data-idx="${i}"></span>`
  ).join('');
  document.getElementById('igDots').querySelectorAll('.dot').forEach(dot => {
    dot.onclick = () => setActiveSlide(parseInt(dot.dataset.idx));
  });

  const cap = document.getElementById('caption').value;
  document.getElementById('previewCaption').textContent = cap || 'Caption‚Ä¶';
  document.getElementById('previewMore').style.display = 'none';

  renderHashtags();
}

function copyCurrentSlide() {
  const slides = getSlides();
  const s = slides[activeSlideIdx];
  const n = getSlides().length;
  navigator.clipboard.writeText(`Slide ${activeSlideIdx+1}/${n}: ${s.title}\n${s.body}`);
  showToast('Slide copiado', 'success');
}

function toggleCopyMenu() { document.getElementById('copyMenu').classList.toggle('hidden'); }
function closeCopyMenu() { document.getElementById('copyMenu').classList.add('hidden'); }
document.addEventListener('click', e => { if (!e.target.closest('.copy-dropdown')) closeCopyMenu(); });

async function saveDraft() {
  const btn = document.getElementById('btnSave');
  btn.disabled = true;
  btn.textContent = 'Guardando‚Ä¶';
  const r = await fetch(`/api/ig/${draftId}`, {
    method: 'PATCH',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(getPayload()),
  });
  btn.disabled = false;
  btn.textContent = 'Guardar';
  if (r.ok) showToast('Guardado ‚úì', 'success');
  else showToast('Error: ' + ((await r.json()).detail || 'Unknown'), 'error');
}

function copyCaption() {
  navigator.clipboard.writeText(document.getElementById('caption').value);
  showToast('Caption copiado', 'success');
}
function copyCarousel() {
  const slides = getSlides();
  const n = slides.length;
  navigator.clipboard.writeText(slides.map((s, i) => `Slide ${i+1}/${n}: ${s.title}\n${s.body}`).join('\n\n'));
  showToast('Carrusel copiado', 'success');
}
function copyAll() {
  const caption = document.getElementById('caption').value;
  const slides = getSlides();
  const n = slides.length;
  const carouselTxt = slides.map((s, i) => `Slide ${i+1}/${n}: ${s.title}\n${s.body}`).join('\n\n');
  const all = [caption, carouselTxt, hashtags.join(' '), document.getElementById('source_line').value].filter(Boolean).join('\n\n---\n\n');
  navigator.clipboard.writeText(all);
  showToast('Todo copiado', 'success');
}

document.querySelectorAll('.slide-title, .slide-body').forEach(el => {
  el.addEventListener('input', () => {
    const i = el.dataset.i;
    if (el.classList.contains('slide-title')) {
      document.getElementById('titleCount'+i).textContent = el.value.length;
    } else {
      const cnt = document.getElementById('bodyCount'+i);
      cnt.textContent = el.value.length + '/110';
      cnt.classList.toggle('warn', el.value.length > 110);
    }
    updatePreview();
  });
});
document.getElementById('caption').addEventListener('input', () => {
  document.getElementById('captionCount').textContent = document.getElementById('caption').value.length + '/900';
  updatePreview();
});

document.querySelectorAll('.slide-tab').forEach((b, i) => b.classList.toggle('active', i === 0));

renderHashtags();
document.querySelectorAll('.slide-title, .slide-body').forEach(el => el.dispatchEvent(new Event('input')));
document.getElementById('caption').dispatchEvent(new Event('input'));
updatePreview();
</script>

{% endblock %}
